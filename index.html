<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
    <title>G1 Mortgage Assistant Widget</title>
    <meta name="robots" content="noindex, nofollow" />

    <style>
      :root {
        --bg-primary: #FFFFFF;
        --bg-assistant: #F3F4F6;
        --bg-user: #DBEAFE;
        --text-primary: #111827;
        --text-secondary: #6B7280;
        --text-inverse: #FFFFFF;
        --border: #E5E7EB;
        --accent: #3B82F6;
        --send-btn: #9CA3AF;
        --send-btn-hover: #3B82F6;
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 15px;
        color: var(--text-primary);
        background: var(--bg-primary);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ── Widget Shell ── */
      .chat-widget {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        height: 100vh;
        width: 100%;
        background: var(--bg-primary);
        position: relative;
      }

      /* ── Messages Container ── */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .messages-container::-webkit-scrollbar {
        width: 4px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      /* ── Welcome Message ── */
      .welcome-prompt {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 24px 16px;
        text-align: center;
        min-height: 200px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .welcome-prompt.hidden {
        display: none;
      }

      .welcome-prompt p {
        font-size: 15px;
        color: var(--text-secondary);
        max-width: 260px;
        line-height: 1.6;
      }

      /* ── Message Bubbles ── */
      .message-row {
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
      }

      .message-row.assistant {
        align-items: flex-start;
      }

      .message-row.user {
        align-items: flex-end;
      }

      .message-bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.6;
        font-size: 14px;
      }

      .message-row.assistant .message-bubble {
        background: var(--bg-assistant);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
      }

      .message-row.user .message-bubble {
        background: var(--bg-user);
        color: var(--text-primary);
        border-bottom-right-radius: 4px;
      }

      /* Static disclaimer under input */
      .input-disclaimer {
        font-size: 10px;
        color: var(--text-secondary);
        text-align: center;
        padding: 4px 12px 8px;
        line-height: 1.3;
        background: var(--bg-primary);
        flex-shrink: 0;
      }

      /* ── Rich Text in Assistant Bubbles ── */
      .message-bubble h3,
      .message-bubble h4 {
        margin: 0 0 8px 0;
        font-weight: 600;
      }
      .message-bubble h3 { font-size: 15px; }
      .message-bubble h4 { font-size: 14px; }

      .message-bubble p {
        margin: 0 0 8px 0;
      }
      .message-bubble p:last-child {
        margin-bottom: 0;
      }

      .message-bubble ul,
      .message-bubble ol {
        margin: 8px 0;
        padding-left: 20px;
      }
      .message-bubble li {
        margin: 4px 0;
      }

      .message-bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 12px;
      }
      .message-row.assistant .message-bubble th,
      .message-row.assistant .message-bubble td {
        border: 1px solid var(--border);
        padding: 6px 8px;
        text-align: left;
      }
      .message-row.assistant .message-bubble th {
        background: rgba(0, 0, 0, 0.04);
        font-weight: 600;
      }
      .message-row.assistant .message-bubble tr:nth-child(even) td {
        background: rgba(0, 0, 0, 0.02);
      }

      .message-bubble strong {
        font-weight: 600;
      }

      .message-bubble a {
        color: inherit;
        text-decoration: underline;
      }

      /* ── Thinking / Loading ── */
      .thinking-row {
        display: flex;
        align-items: flex-start;
        animation: slideIn 0.3s ease;
      }

      .thinking-bubble {
        background: var(--bg-assistant);
        color: var(--text-primary);
        padding: 14px 18px;
        border-radius: var(--radius-md);
        border-bottom-left-radius: 4px;
        max-width: 85%;
      }

      .thinking-dots {
        display: flex;
        align-items: center;
        gap: 5px;
        height: 20px;
      }

      .thinking-dots span {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        animation: dotPulse 1.4s ease-in-out infinite;
      }

      .thinking-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .thinking-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotPulse {
        0%, 80%, 100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* ── Centered input state (before chat starts) ── */
      .chat-widget.centered .messages-container {
        display: flex;
        flex: 1;
      }

      .chat-widget.centered .input-zone {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 24px);
        max-width: 500px;
      }

      .chat-widget.centered .input-container {
        border-top: none;
      }

      .chat-widget.centered .input-disclaimer {
        padding-bottom: 0;
      }

      /* ── Docked input state (after chat starts) ── */
      .chat-widget:not(.centered) .input-zone {
        flex-shrink: 0;
        transition: all 0.3s ease;
      }

      /* ── Input Zone ── */
      .input-container {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
        flex-shrink: 0;
      }

      /* ── Thinking Stages ── */
      .thinking-stages {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 4px 0;
      }

      .thinking-stage {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: var(--radius-sm);
        font-size: 13px;
        color: var(--text-secondary);
        opacity: 0;
        transform: translateX(-8px);
        animation: stageIn 0.3s ease forwards;
      }

      @keyframes stageIn {
        to { opacity: 1; transform: translateX(0); }
      }

      .thinking-stage.active {
        color: var(--accent);
        background: rgba(59, 130, 246, 0.08);
      }

      .thinking-stage.complete {
        color: #10B981;
        background: rgba(16, 185, 129, 0.08);
      }

      .thinking-stage .stage-icon {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thinking-stage .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .thinking-stage .check-icon {
        color: #10B981;
      }

      .thinking-stage .stage-text {
        flex: 1;
        font-weight: 500;
      }

      .thinking-stage .stage-time {
        font-size: 11px;
        opacity: 0.7;
      }

      .input-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 12px 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-height: 56px;
      }

      .input-wrapper:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .input-field {
        flex: 1;
        border: none;
        background: transparent;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: 16px;
        line-height: 1.5;
        color: var(--text-primary);
        min-height: 24px;
        max-height: 160px;
        padding: 0;
        overflow-y: auto;
        -webkit-appearance: none;
        appearance: none;
      }

      .input-field::placeholder {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .send-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: var(--send-btn);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, transform 0.15s;
        flex-shrink: 0;
        -webkit-tap-highlight-color: transparent;
        margin-bottom: 2px;
      }

      .send-btn:hover:not(:disabled) {
        background: var(--send-btn-hover);
      }

      .send-btn:active:not(:disabled) {
        transform: scale(0.92);
      }

      .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .send-btn:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .send-btn svg {
        width: 20px;
        height: 20px;
      }

      /* ── Error message ── */
      .error-bubble {
        background: #FEF2F2 !important;
        color: #991B1B !important;
        border: 1px solid #FECACA;
      }

      /* ── Animations ── */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ── Responsive: Mobile ── */
      @media (max-width: 600px) {
        .messages-container {
          padding: 12px 8px;
          gap: 6px;
        }

        .message-bubble {
          font-size: 14px;
          padding: 10px 14px;
          max-width: 88%;
        }

        .input-container {
          padding: 8px;
        }

        .input-wrapper {
          padding: 10px 12px;
          min-height: 50px;
        }

        .input-field {
          font-size: 16px;
        }
      }

      /* ── Responsive: Tablet ── */
      @media (min-width: 601px) and (max-width: 1024px) {
        .messages-container {
          padding: 14px 10px;
        }

        .input-container {
          padding: 10px;
        }

        .input-wrapper {
          min-height: 54px;
        }

        .input-field {
          font-size: 15px;
        }
      }

      /* ── Desktop ── */
      @media (min-width: 1025px) {
        .message-bubble {
          font-size: 15px;
        }
      }

      /* ── Safe area for notched devices ── */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .input-container {
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
      }

      /* ── Reduced motion ── */
      @media (prefers-reduced-motion: reduce) {
        .message-row,
        .thinking-row {
          animation: none;
        }

        .thinking-dots span {
          animation: none;
          opacity: 0.5;
        }

        .messages-container {
          scroll-behavior: auto;
        }
      }

      /* ── Focus visible for keyboard users ── */
      .input-wrapper:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }
    </style>
  </head>

  <body>
    <div class="chat-widget centered" id="chatWidget" role="main" aria-label="Mortgage Assistant Chat">
      <!-- Messages Area -->
      <div class="messages-container" id="messagesContainer" role="log" aria-live="polite" aria-label="Chat messages">
        <div class="welcome-prompt" id="welcomePrompt">
          <p>Ask me anything about mortgages, rates, refinancing, or home buying.</p>
        </div>
      </div>

      <!-- Input Zone (floats center initially, docks to bottom on chat start) -->
      <div class="input-zone" id="inputZone">
        <form class="input-container" id="inputForm" autocomplete="off" role="form" aria-label="Send a message">
          <div class="input-wrapper">
            <label for="inputField" class="sr-only" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">Type your message</label>
            <textarea
              id="inputField"
              class="input-field"
              rows="1"
              placeholder="Ask me anything about your mortgage..."
              aria-label="Message input"
              autocomplete="off"
              enterkeyhint="send"
            ></textarea>
          </div>
          <button type="submit" class="send-btn" id="sendBtn" disabled aria-label="Send message">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </form>
        <div class="input-disclaimer" aria-hidden="true">AI agents can make mistakes. Check important info. Intended for informational use.</div>
      </div>
    </div>

    <script>
      (function() {
        'use strict';

        const PROXY_URL = '/api/chat';

        const chatWidget = document.getElementById('chatWidget');
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomePrompt = document.getElementById('welcomePrompt');
        const inputForm = document.getElementById('inputForm');
        const inputField = document.getElementById('inputField');
        const sendBtn = document.getElementById('sendBtn');

        let conversationHistory = [];
        let isProcessing = false;
        let chatStarted = false;

        // ── Thinking stages config ──
        const thinkingStages = [
          { id: 'analyze', text: 'Analyzing your question' },
          { id: 'search', text: 'Searching program matrices' },
          { id: 'calculate', text: 'Calculating eligibility' },
          { id: 'format', text: 'Preparing response' }
        ];
        let stageTimers = [];
        let stageStartTime = 0;
        let currentStageIndex = 0;
        let elapsedInterval = null;

        // ── Auto-grow textarea ──
        const autoGrow = (el) => {
          el.style.height = '24px';
          el.style.height = Math.min(el.scrollHeight, 160) + 'px';
        };

        // ── Helpers ──

        const scrollToBottom = () => {
          requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          });
        };

        const dockInput = () => {
          if (!chatStarted) {
            chatStarted = true;
            chatWidget.classList.remove('centered');
          }
          if (welcomePrompt && !welcomePrompt.classList.contains('hidden')) {
            welcomePrompt.classList.add('hidden');
          }
        };

        const updateSendBtn = () => {
          sendBtn.disabled = !inputField.value.trim() || isProcessing;
        };

        // ── Markdown Formatting ──

        const formatCellContent = (text) => {
          return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };

        const convertMarkdownTables = (text) => {
          const tableRegex = /\|(.+)\|\n\|[-|\s]+\|\n((?:\|.+\|\n?)+)/g;
          return text.replace(tableRegex, (match, headerRow, bodyRows) => {
            const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
            const rows = bodyRows.trim().split('\n');
            let table = '<table><thead><tr>';
            headers.forEach(h => { table += '<th>' + formatCellContent(h) + '</th>'; });
            table += '</tr></thead><tbody>';
            rows.forEach(row => {
              const cells = row.split('|').map(c => c.trim()).filter(c => c);
              table += '<tr>';
              cells.forEach(c => { table += '<td>' + formatCellContent(c) + '</td>'; });
              table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
          });
        };

        const formatResponse = (text) => {
          if (!text) return 'No response received.';
          let f = text;

          // Tables first
          f = convertMarkdownTables(f);

          // Headers
          f = f.replace(/^### (.*$)/gm, '<h4>$1</h4>');
          f = f.replace(/^## (.*$)/gm, '<h3>$1</h3>');

          // Bold & italic
          f = f.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          f = f.replace(/\*(.*?)\*/g, '<em>$1</em>');

          // Bullets
          f = f.replace(/^- (.*$)/gm, '<li>$1</li>');
          f = f.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

          // Numbered lists
          f = f.replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>');

          // Line breaks
          f = f.replace(/\n\n/g, '</p><p>');
          f = f.replace(/\n/g, '<br>');

          if (!f.startsWith('<')) {
            f = '<p>' + f + '</p>';
          }
          return f;
        };

        // ── Message Rendering ──

        const addMessage = (role, text, isError) => {
          // Clear thinking stages and remove indicator
          const thinkingEl = document.getElementById('thinkingIndicator');
          if (thinkingEl) {
            clearThinkingStages();
            setTimeout(() => thinkingEl.remove(), 300);
          }

          const row = document.createElement('div');
          row.className = 'message-row ' + role;
          row.setAttribute('role', 'article');
          row.setAttribute('aria-label', role === 'user' ? 'You said' : 'Assistant said');

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble' + (isError ? ' error-bubble' : '');

          if (role === 'assistant') {
            bubble.innerHTML = formatResponse(text);
          } else {
            bubble.textContent = text;
          }

          row.appendChild(bubble);
          messagesContainer.appendChild(row);
          scrollToBottom();
        };

        const showThinking = () => {
          const row = document.createElement('div');
          row.className = 'message-row assistant';
          row.id = 'thinkingIndicator';
          row.setAttribute('role', 'status');
          row.setAttribute('aria-label', 'Assistant is thinking');

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';

          let html = '<div class="thinking-stages">';
          thinkingStages.forEach(stage => {
            html += '<div class="thinking-stage" id="stage-' + stage.id + '" style="display:none;">' +
              '<div class="stage-icon"><div class="spinner"></div></div>' +
              '<span class="stage-text">' + stage.text + '</span>' +
              '<span class="stage-time" id="time-' + stage.id + '"></span>' +
              '</div>';
          });
          html += '</div>';
          bubble.innerHTML = html;

          row.appendChild(bubble);
          messagesContainer.appendChild(row);
          scrollToBottom();
          startThinkingStages();
        };

        const startThinkingStages = () => {
          stageStartTime = Date.now();
          currentStageIndex = 0;
          stageTimers = [];
          activateStage(0);
          stageTimers.push(setTimeout(() => { completeStage(0); activateStage(1); }, 600));
          stageTimers.push(setTimeout(() => { completeStage(1); activateStage(2); }, 1500));
          stageTimers.push(setTimeout(() => { completeStage(2); activateStage(3); }, 2800));
          elapsedInterval = setInterval(updateElapsedTime, 100);
        };

        const activateStage = (index) => {
          if (index >= thinkingStages.length) return;
          const stage = document.getElementById('stage-' + thinkingStages[index].id);
          if (stage) {
            stage.style.display = 'flex';
            stage.className = 'thinking-stage active';
            currentStageIndex = index;
            scrollToBottom();
          }
        };

        const completeStage = (index) => {
          if (index >= thinkingStages.length) return;
          const stage = document.getElementById('stage-' + thinkingStages[index].id);
          if (stage) {
            stage.className = 'thinking-stage complete';
            stage.querySelector('.stage-icon').innerHTML = '<svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          }
        };

        const updateElapsedTime = () => {
          const elapsed = ((Date.now() - stageStartTime) / 1000).toFixed(1);
          const timeEl = document.getElementById('time-' + thinkingStages[currentStageIndex].id);
          if (timeEl) timeEl.textContent = elapsed + 's';
        };

        const clearThinkingStages = () => {
          stageTimers.forEach(timer => clearTimeout(timer));
          stageTimers = [];
          if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
          thinkingStages.forEach((stage, i) => {
            completeStage(i);
            const el = document.getElementById('stage-' + stage.id);
            if (el) el.style.display = 'flex';
          });
        };

        // ── Send Message ──

        const sendMessage = async (text) => {
          if (isProcessing || !text) return;

          dockInput();
          isProcessing = true;

          addMessage('user', text);
          conversationHistory.push({ role: 'user', content: text });

          showThinking();
          updateSendBtn();

          try {
            const res = await fetch(PROXY_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: text,
                conversationHistory: conversationHistory,
                lastFormValues: {},
                enableCaching: true
              }),
            });

            if (!res.ok) throw new Error('Request failed (' + res.status + ')');

            const data = await res.json();
            const responseText = data.response || data.message || JSON.stringify(data);

            conversationHistory.push({ role: 'assistant', content: responseText });
            addMessage('assistant', responseText);

          } catch (err) {
            addMessage('assistant', 'Something went wrong. Please try again.', true);
          }

          isProcessing = false;
          updateSendBtn();
          inputField.focus();
        };

        // ── Event Listeners ──

        inputField.addEventListener('input', () => {
          autoGrow(inputField);
          updateSendBtn();
        });

        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) inputForm.requestSubmit();
          }
        });

        // Escape to clear input
        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            inputField.value = '';
            updateSendBtn();
          }
        });

        inputForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const text = inputField.value.trim();
          if (!text) return;
          inputField.value = '';
          inputField.style.height = '24px';
          updateSendBtn();
          sendMessage(text);
        });

        // ── Prevent parent page scroll conflicts ──
        messagesContainer.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        }, { passive: true });

        // ── Adjust for mobile keyboard ──
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', () => {
            scrollToBottom();
          });
        }

        // ── Init ──
        updateSendBtn();
        inputField.focus();

        // Notify parent frame the widget is ready
        try {
          if (window.parent !== window) {
            window.parent.postMessage({ type: 'g1-widget-ready' }, '*');
          }
        } catch (e) { /* cross-origin, ignore */ }

      })();
    </script>
  </body>
</html>
