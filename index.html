<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
    <title>G1 Mortgage Assistant Widget</title>
    <meta name="robots" content="noindex, nofollow" />

    <style>
      :root {
        --bg-primary: #FFFFFF;
        --bg-assistant: #1F2937;
        --bg-user: #DBEAFE;
        --text-primary: #111827;
        --text-secondary: #6B7280;
        --text-inverse: #FFFFFF;
        --border: #E5E7EB;
        --accent: #3B82F6;
        --send-btn: #9CA3AF;
        --send-btn-hover: #3B82F6;
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 15px;
        color: var(--text-primary);
        background: var(--bg-primary);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ── Widget Shell ── */
      .chat-widget {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        height: 100vh;
        width: 100%;
        background: var(--bg-primary);
        position: relative;
      }

      /* ── Messages Container ── */
      .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .messages-container::-webkit-scrollbar {
        width: 4px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      /* ── Welcome Message ── */
      .welcome-prompt {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 24px 16px;
        text-align: center;
        min-height: 200px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .welcome-prompt.hidden {
        display: none;
      }

      .welcome-prompt p {
        font-size: 15px;
        color: var(--text-secondary);
        max-width: 260px;
        line-height: 1.6;
      }

      /* ── Message Bubbles ── */
      .message-row {
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
      }

      .message-row.assistant {
        align-items: flex-start;
      }

      .message-row.user {
        align-items: flex-end;
      }

      .message-bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.6;
        font-size: 14px;
      }

      .message-row.assistant .message-bubble {
        background: var(--bg-assistant);
        color: var(--text-inverse);
        border-bottom-left-radius: 4px;
      }

      .message-row.user .message-bubble {
        background: var(--bg-user);
        color: var(--text-primary);
        border-bottom-right-radius: 4px;
      }

      /* Disclaimer under user messages */
      .message-disclaimer {
        font-size: 10px;
        color: var(--text-secondary);
        margin-top: 4px;
        padding-right: 4px;
        line-height: 1.3;
        max-width: 85%;
        text-align: right;
      }

      /* ── Rich Text in Assistant Bubbles ── */
      .message-bubble h3,
      .message-bubble h4 {
        margin: 0 0 8px 0;
        font-weight: 600;
      }
      .message-bubble h3 { font-size: 15px; }
      .message-bubble h4 { font-size: 14px; }

      .message-bubble p {
        margin: 0 0 8px 0;
      }
      .message-bubble p:last-child {
        margin-bottom: 0;
      }

      .message-bubble ul,
      .message-bubble ol {
        margin: 8px 0;
        padding-left: 20px;
      }
      .message-bubble li {
        margin: 4px 0;
      }

      .message-bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 12px;
      }
      .message-row.assistant .message-bubble th,
      .message-row.assistant .message-bubble td {
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 6px 8px;
        text-align: left;
      }
      .message-row.assistant .message-bubble th {
        background: rgba(255, 255, 255, 0.08);
        font-weight: 600;
      }
      .message-row.assistant .message-bubble tr:nth-child(even) td {
        background: rgba(255, 255, 255, 0.04);
      }

      .message-bubble strong {
        font-weight: 600;
      }

      .message-bubble a {
        color: inherit;
        text-decoration: underline;
      }

      /* ── Thinking / Loading ── */
      .thinking-row {
        display: flex;
        align-items: flex-start;
        animation: slideIn 0.3s ease;
      }

      .thinking-bubble {
        background: var(--bg-assistant);
        color: var(--text-inverse);
        padding: 14px 18px;
        border-radius: var(--radius-md);
        border-bottom-left-radius: 4px;
        max-width: 85%;
      }

      .thinking-dots {
        display: flex;
        align-items: center;
        gap: 5px;
        height: 20px;
      }

      .thinking-dots span {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        animation: dotPulse 1.4s ease-in-out infinite;
      }

      .thinking-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .thinking-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotPulse {
        0%, 80%, 100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* ── Input Zone ── */
      .input-container {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
        flex-shrink: 0;
      }

      .input-field {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 16px;
        line-height: 1.4;
        color: var(--text-primary);
        background: var(--bg-primary);
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-height: 44px;
        -webkit-appearance: none;
        appearance: none;
      }

      .input-field::placeholder {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .input-field:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .send-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: var(--send-btn);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, transform 0.15s;
        flex-shrink: 0;
        -webkit-tap-highlight-color: transparent;
      }

      .send-btn:hover:not(:disabled) {
        background: var(--send-btn-hover);
      }

      .send-btn:active:not(:disabled) {
        transform: scale(0.92);
      }

      .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .send-btn:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .send-btn svg {
        width: 20px;
        height: 20px;
      }

      /* ── Error message ── */
      .error-bubble {
        background: #FEF2F2 !important;
        color: #991B1B !important;
        border: 1px solid #FECACA;
      }

      /* ── Animations ── */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ── Responsive: Mobile ── */
      @media (max-width: 600px) {
        .messages-container {
          padding: 12px 8px;
          gap: 6px;
        }

        .message-bubble {
          font-size: 14px;
          padding: 10px 14px;
          max-width: 88%;
        }

        .message-disclaimer {
          max-width: 88%;
        }

        .input-container {
          padding: 8px;
        }

        .input-field {
          font-size: 16px;
          padding: 10px 12px;
        }
      }

      /* ── Responsive: Tablet ── */
      @media (min-width: 601px) and (max-width: 1024px) {
        .messages-container {
          padding: 14px 10px;
        }

        .input-container {
          padding: 10px;
        }

        .input-field {
          font-size: 15px;
        }
      }

      /* ── Desktop ── */
      @media (min-width: 1025px) {
        .message-bubble {
          font-size: 15px;
        }
      }

      /* ── Safe area for notched devices ── */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .input-container {
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
      }

      /* ── Reduced motion ── */
      @media (prefers-reduced-motion: reduce) {
        .message-row,
        .thinking-row {
          animation: none;
        }

        .thinking-dots span {
          animation: none;
          opacity: 0.5;
        }

        .messages-container {
          scroll-behavior: auto;
        }
      }

      /* ── Focus visible for keyboard users ── */
      .input-field:focus-visible {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
      }
    </style>
  </head>

  <body>
    <div class="chat-widget" role="main" aria-label="Mortgage Assistant Chat">
      <!-- Messages Area -->
      <div class="messages-container" id="messagesContainer" role="log" aria-live="polite" aria-label="Chat messages">
        <div class="welcome-prompt" id="welcomePrompt">
          <p>Ask me anything about mortgages, rates, refinancing, or home buying.</p>
        </div>
      </div>

      <!-- Input Zone -->
      <form class="input-container" id="inputForm" autocomplete="off" role="form" aria-label="Send a message">
        <label for="inputField" class="sr-only" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;">Type your message</label>
        <input
          type="text"
          id="inputField"
          class="input-field"
          placeholder="Ask me anything about your mortgage..."
          aria-label="Message input"
          autocomplete="off"
          enterkeyhint="send"
        />
        <button type="submit" class="send-btn" id="sendBtn" disabled aria-label="Send message">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </button>
      </form>
    </div>

    <script>
      (function() {
        'use strict';

        const PROXY_URL = '/api/chat';
        const DISCLAIMER_TEXT = 'AI agents can make mistakes. Check important info. Intended for informational use.';

        const messagesContainer = document.getElementById('messagesContainer');
        const welcomePrompt = document.getElementById('welcomePrompt');
        const inputForm = document.getElementById('inputForm');
        const inputField = document.getElementById('inputField');
        const sendBtn = document.getElementById('sendBtn');

        let conversationHistory = [];
        let isProcessing = false;

        // ── Helpers ──

        const scrollToBottom = () => {
          requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          });
        };

        const hideWelcome = () => {
          if (welcomePrompt && !welcomePrompt.classList.contains('hidden')) {
            welcomePrompt.classList.add('hidden');
          }
        };

        const updateSendBtn = () => {
          sendBtn.disabled = !inputField.value.trim() || isProcessing;
        };

        // ── Markdown Formatting ──

        const formatCellContent = (text) => {
          return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };

        const convertMarkdownTables = (text) => {
          const tableRegex = /\|(.+)\|\n\|[-|\s]+\|\n((?:\|.+\|\n?)+)/g;
          return text.replace(tableRegex, (match, headerRow, bodyRows) => {
            const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
            const rows = bodyRows.trim().split('\n');
            let table = '<table><thead><tr>';
            headers.forEach(h => { table += '<th>' + formatCellContent(h) + '</th>'; });
            table += '</tr></thead><tbody>';
            rows.forEach(row => {
              const cells = row.split('|').map(c => c.trim()).filter(c => c);
              table += '<tr>';
              cells.forEach(c => { table += '<td>' + formatCellContent(c) + '</td>'; });
              table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
          });
        };

        const formatResponse = (text) => {
          if (!text) return 'No response received.';
          let f = text;

          // Tables first
          f = convertMarkdownTables(f);

          // Headers
          f = f.replace(/^### (.*$)/gm, '<h4>$1</h4>');
          f = f.replace(/^## (.*$)/gm, '<h3>$1</h3>');

          // Bold & italic
          f = f.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          f = f.replace(/\*(.*?)\*/g, '<em>$1</em>');

          // Bullets
          f = f.replace(/^- (.*$)/gm, '<li>$1</li>');
          f = f.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

          // Numbered lists
          f = f.replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>');

          // Line breaks
          f = f.replace(/\n\n/g, '</p><p>');
          f = f.replace(/\n/g, '<br>');

          if (!f.startsWith('<')) {
            f = '<p>' + f + '</p>';
          }
          return f;
        };

        // ── Message Rendering ──

        const addMessage = (role, text, isError) => {
          // Remove thinking indicator
          const thinkingEl = document.getElementById('thinkingIndicator');
          if (thinkingEl) thinkingEl.remove();

          const row = document.createElement('div');
          row.className = 'message-row ' + role;
          row.setAttribute('role', 'article');
          row.setAttribute('aria-label', role === 'user' ? 'You said' : 'Assistant said');

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble' + (isError ? ' error-bubble' : '');

          if (role === 'assistant') {
            bubble.innerHTML = formatResponse(text);
          } else {
            bubble.textContent = text;
          }

          row.appendChild(bubble);

          // Add disclaimer under user messages
          if (role === 'user') {
            const disclaimer = document.createElement('div');
            disclaimer.className = 'message-disclaimer';
            disclaimer.textContent = DISCLAIMER_TEXT;
            disclaimer.setAttribute('aria-hidden', 'true');
            row.appendChild(disclaimer);
          }

          messagesContainer.appendChild(row);
          scrollToBottom();
        };

        const showThinking = () => {
          const row = document.createElement('div');
          row.className = 'thinking-row';
          row.id = 'thinkingIndicator';
          row.setAttribute('role', 'status');
          row.setAttribute('aria-label', 'Assistant is typing');

          const bubble = document.createElement('div');
          bubble.className = 'thinking-bubble';
          bubble.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';

          row.appendChild(bubble);
          messagesContainer.appendChild(row);
          scrollToBottom();
        };

        // ── Send Message ──

        const sendMessage = async (text) => {
          if (isProcessing || !text) return;

          hideWelcome();
          isProcessing = true;

          addMessage('user', text);
          conversationHistory.push({ role: 'user', content: text });

          showThinking();
          updateSendBtn();

          try {
            const res = await fetch(PROXY_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: text,
                conversationHistory: conversationHistory,
                lastFormValues: {},
                enableCaching: true
              }),
            });

            if (!res.ok) throw new Error('Request failed (' + res.status + ')');

            const data = await res.json();
            const responseText = data.response || data.message || JSON.stringify(data);

            conversationHistory.push({ role: 'assistant', content: responseText });
            addMessage('assistant', responseText);

          } catch (err) {
            addMessage('assistant', 'Something went wrong. Please try again.', true);
          }

          isProcessing = false;
          updateSendBtn();
          inputField.focus();
        };

        // ── Event Listeners ──

        inputField.addEventListener('input', updateSendBtn);

        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) inputForm.requestSubmit();
          }
        });

        // Escape to clear input
        inputField.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            inputField.value = '';
            updateSendBtn();
          }
        });

        inputForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const text = inputField.value.trim();
          if (!text) return;
          inputField.value = '';
          updateSendBtn();
          sendMessage(text);
        });

        // ── Prevent parent page scroll conflicts ──
        messagesContainer.addEventListener('touchmove', (e) => {
          e.stopPropagation();
        }, { passive: true });

        // ── Adjust for mobile keyboard ──
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', () => {
            scrollToBottom();
          });
        }

        // ── Init ──
        updateSendBtn();
        inputField.focus();

        // Notify parent frame the widget is ready
        try {
          if (window.parent !== window) {
            window.parent.postMessage({ type: 'g1-widget-ready' }, '*');
          }
        } catch (e) { /* cross-origin, ignore */ }

      })();
    </script>
  </body>
</html>
